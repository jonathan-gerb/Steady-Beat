<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <script src="./waves-ui-master/waves-ui.umd.js"></script>
    <script src="./waves-audio-master/examples/assets/prism.js"></script>
    <script src="./waves-audio-master/examples/assets/waves-loaders.min.js"></script>
</head>

<body>
    <h1>Axis Layer</h1>
    <div class="track" id="track-1"></div>
    <script class="example" rel="track-1">
    var loader = new wavesLoaders.AudioBufferLoader();

    loader.load('toymarch.wav').then(function(buffer) {
        var $track = document.querySelector('#track-1');
        var width = $track.getBoundingClientRect().width;
        var timeAxisHeight = 18; // height of text above waveform
        var layerHeight = 200; // height of waveform

        var data = [{
            x: 2,
            width: 4,
            color: 'steelblue',
            opacity: 0.8,
            text: 'this is a region.'
        }, {
            x: 10,
            width: 5,
            color: 'orange',
            opacity: 0.8
        }, {
            x: 14,
            width: 3,
            color: 'green',
            opacity: 0.8
        }, ];

        var segmentLayer = new wavesUI.helpers.SegmentLayer(data, {
            height: layerHeight,
            displayHandlers: true,
        });

        var beatMarkers = [{
            time: 2,
            text: ' '
        }, {
            time: 5,
            text: ' '
        }, {
            time: 6,
            text: ' '
        }, {
            time: 8,
            text: ' '
        }, ];

        // var segmentLayer = new wavesUI.core.Layer('collection', data, {
        //     height: layerHeight
        // });


        var duration = buffer.duration;
        var pixelsPerSecond = width / duration;

        window.addEventListener("keydown", checkKeyPressed, false);
        var clickSound = new Audio('click.mp3');


        function checkKeyPressed(e) {
            var evtobj = window.event ? event : e
            if (e.keyCode == "66") {
                recordTimeStamp();
                clickSound.play();
            }
        }

        function recordTimeStamp() {
            var currentTime = new Date().getTime() / 1000;
            var newmarker = {
                time: currentTime % duration,
                text: ' '
            }
            beatMarkers.push(newmarker);

            markerLayer.render();
            markerLayer.update();
        }

        var timeline = new wavesUI.core.Timeline(pixelsPerSecond, width);
        // var track = new wavesUI.core.Track($track, layerHeight + timeAxisHeight, 'main');
        // timeline.add(track);

        var track = timeline.createTrack($track, layerHeight + timeAxisHeight, 'main');

        // marker layer
        var markerLayer = new wavesUI.core.Layer('collection', beatMarkers, {
            height: layerHeight
        });

        // time axis
        var timeAxis = new wavesUI.axis.AxisLayer(wavesUI.axis.timeAxisGenerator(), {
            height: timeAxisHeight
        });

        var timeContext = new wavesUI.core.LayerTimeContext(timeline.timeContext);

        markerLayer.setTimeContext(timeContext);
        markerLayer.configureShape(wavesUI.shapes.AnnotatedMarker, {
            x: function(d, v) {
                if (v !== undefined) {
                    d.time = v;
                }
                return d.time;
            },
            color: function() {
                return 'red';
            }
        });

        markerLayer.setBehavior(new wavesUI.behaviors.MarkerBehavior());

        // Axis layers use `timeline.TimeContext` directly,
        // they don't have their own timeContext
        timeAxis.setTimeContext(timeline.timeContext);
        timeAxis.configureShape(wavesUI.shapes.Ticks, {}, {
            color: 'steelblue'
        });

        // bpm axis
        var grid = new wavesUI.axis.AxisLayer(wavesUI.axis.gridAxisGenerator(10, '4/4'), {
            height: layerHeight,
            top: timeAxisHeight
        });

        grid.setTimeContext(timeline.timeContext);
        grid.configureShape(wavesUI.shapes.Ticks, {}, {
            color: 'green'
        });

        // wavesform layer
        var waveformLayer = new wavesUI.helpers.WaveformLayer(buffer, {
            height: layerHeight,
            top: timeAxisHeight
        });

        waveformLayer.setTimeContext(new wavesUI.core.LayerTimeContext(timeline.timeContext));

        var cursorLayer = new wavesUI.helpers.CursorLayer({
            height: layerHeight
        });


        timeline.addLayer(cursorLayer, 'main');
        timeline.addLayer(segmentLayer, 'main');

        track.add(timeAxis);
        // track.add(grid);
        track.add(waveformLayer);
        track.add(markerLayer);

        track.render();
        track.update();

        timeline.tracks.render();
        timeline.tracks.update();

        timeline.state = new wavesUI.states.CenteredZoomState(timeline);

        // listen for time passing...
        (function loop() {
            var currentTime = new Date().getTime() / 1000;
            cursorLayer.currentPosition = currentTime % duration;
            cursorLayer.update();

            requestAnimationFrame(loop);
        }());

        timeline.on('event', function(e) {
            var segment;
            var eventType = e.type;

            if (eventType !== 'mouseover' && eventType !== 'mouseout') {
                return;
            }

            segment = segmentLayer.getItemFromDOMElement(e.target);

            if (segment !== null) {
                var datum = segmentLayer.getDatumFromItem(segment);
                datum.opacity = eventType === 'mouseover' ? 1 : 0.8;
                segmentLayer.updateShapes();
            }
        });
    });
    </script>
</body>

</html>
