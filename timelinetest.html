<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <script src="./waves-ui-master/waves-ui.umd.js"></script>
    <script src="./waves-audio-master/examples/assets/prism.js"></script>
    <script src="./waves-audio-master/examples/assets/waves-loaders.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="./icon.jpg">
    <title>Waveform generation page</title>
    <script src="./bootstrap/dist/js/bootstrap.min.js" ></script>
    <!-- Bootstrap core CSS -->
    <link href="bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="bootstrap/docs/assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet">
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="bootstrap/docs/assets/js/ie-emulation-modes-warning.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
    #infotext1,
    #infobutton1 {
        float: bottom-right;
    }

    #infobutton2 {
        float: bottom-right;
    }
    #player {
        position: fixed;
        left: 0;
        bottom: 0;
    }
    #sidebar {
        background-color:DimGray ;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        width: 240px;
    }#bottombar {
        bottom: 0;
        position: absolute;
    }#timelines {
        background-color: DimGray;
        padding-bottom: 10px;
    }#macroTrack {
        background-color: LightGray;
    }#track-1 {
        background-color: DarkGray;
    }.item.annotated-marker.selected {
        color: PeachPuff;
    }
    </style>
</head>

<body>
    <script>
    window.jQuery || document.write('<script src="bootstrap/docs/assets/js/vendor/jquery.min.js"><\/script>')
    </script>
    <div class="site-wrapper" id="pageAnchor">
        <div class="site-wrapper-inner">
            <div class="cover-container">
                <div class="masthead clearfix">
                    <div class="inner">
                        <h3 class="masthead-brand"></h3>
                        <nav class="fixed-header">
                            <ul class="nav masthead-nav">
                                <li><a href="index.html">Song selection</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="inner cover" id="timelines">
                    <h1 class="cover-heading"></h1>
                    <br>
                    <div class="macroTrack" id="macroTrack"></div>
                    <div id="sidebar">
                        <div id="player"></div>
                    </div>
                    <div class="macroTrack" id="macroTrack"></div>
                    <div class="track" id="track-1"></div>
                    <div class="lead" id="loading"><img src="loading.gif" alt="loadingGif" height="50" width="50"></div>
                    <div class="waveform-box" id="waveform"></div>
                    <div style="text-align: center">
                        <button type="button" class="btn btn-default btn-sm" id="playButton" onclick="playOrPause()">
                          <span class="glyphicon glyphicon-play"></span> Play
                        </button>
                        <button type="button" class="btn btn-default btn-sm" id="clickToggle" onclick="toggleClick()">
                          <span class="	glyphicon glyphicon-volume-up"></span> Click ON
                        </button>
                    </div>
                    <p class="lead">Press the 'b' key on the beat to add a beat annotation.
                        <a href="#" id="infotext1" data-toggle="tooltip" data-placement="right" title="Drag a beat marker to move it, or double click to delete it.">
                            <i class="material-icons">help_outline</i>
                        </a>
                    </p>
                    <p class="lead">
                        <a href="#" class="btn btn-lg btn-default" id="reset" onclick="clearMarkers()" data-toggle="tooltip" data-placement="right" title="You can also select a single marker and press delete to remove it!">Clear Markers</a>
                        <a href="#" class="btn btn-lg btn-default" id="toPHP" onclick="writeToFile()">Submit Results</a>
                        <a href="#" id="infotext2" data-toggle="tooltip" data-placement="right" title="The Tracking info is a list which contains the beat annotations you made.">
                            <i class="material-icons">help_outline</i>
                        </a>
                    </p>
                    <p id="showTimeStamps"></p>
                    <textarea rows="4" cols="50" id="markerInfo" style="color:black" hidden>nothing here</textarea>
                </div>
                <div id="bottombar">
                    <div class="inner">
                        <p>Waveform generation by <a href="http://wavesjs.github.io/">WavesJS-UI</a>, Project Members <a href="#">@rockforr</a>, <a href="#">@blane</a>, <a href="#">@nindia</a>, <a href="#">@clarayeah__</a>, <a href="#">@adrivri</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script class="example" rel="track-1">
    var wavesJSReady = false;

    var markerCounter = 5;
    var loader = new wavesLoaders.AudioBufferLoader();
    var ytWav = './mp3files/' + getYoutubeId() + '.wav';
    // var ytWav = 'https://dl.dropboxusercontent.com/s/x96jtzww89u8cdf/Brains.wav'
    loader.load(ytWav).then(function(buffer) {
        wavesJSReady = true;
        initialize(buffer);
    });

    var x = document.createElement("AUDIO");
    if (x.canPlayType("audio/mpeg")) {
        x.setAttribute("src", 'mp3files/'+ getYoutubeId() + ".wav");
        x.setAttribute("hidden", "hidden");
    }
    x.setAttribute("controls", "controls");
    document.body.appendChild(x);

    // variables we need to be global
    var data;
    var markerLayer;
    var beatMarkers = [];
    var segmentLayer;
    var cursorLayerMacro;
    var cursorLayer;
    var playSong;
    var timelineMacro;
    var timeline;
    var trackMacro;
    var track;
    var timeContextMacro;
    var timeContext;
    var startTime;
    var currentTime;
    var finalDur;
    var windowWidth = 20;
    var markerQueue = [];
    var seeking = false;
    var audioplayer = document.getElementsByTagName("AUDIO")[0];

    function initialize(buffer) {
        var $trackMacro = document.querySelector('#macroTrack');
        var $track = document.querySelector('#track-1');
        var width = $track.getBoundingClientRect().width;
        var timeAxisHeight = 18; // height of text above waveform
        var layerHeight = 200; // height of waveform
        var macroTimelineHeight = 60; // height of zoomed out view

        var duration = buffer.duration;
        var pixelsPerSecond = width / duration;

        // Needs to be removed eventually
        data = [{
            x: 0,
            width: duration,
            height: layerHeight,
            top: timeAxisHeight,
            color: 'steelblue',
            opacity: 0.2,
            text: '4/4'
        }, ];

        timeline = new wavesUI.core.Timeline(pixelsPerSecond, width);
        timelineMacro = new wavesUI.core.Timeline(pixelsPerSecond, width);

        track = timeline.createTrack($track, layerHeight + timeAxisHeight, 'main');
        trackMacro = timelineMacro.createTrack($trackMacro, macroTimelineHeight + timeAxisHeight, 'macro');

        timeContext = new wavesUI.core.LayerTimeContext(timeline.timeContext);
        timeContextMacro = new wavesUI.core.LayerTimeContext(timelineMacro.timeContext);

        // time axis
        var timeAxis = new wavesUI.axis.AxisLayer(wavesUI.axis.timeAxisGenerator(), {
            height: timeAxisHeight
        });
        var timeAxisMacro = new wavesUI.axis.AxisLayer(wavesUI.axis.timeAxisGenerator(), {
            height: timeAxisHeight
        });

        timeAxis.setTimeContext(timeline.timeContext);
        timeAxis.configureShape(wavesUI.shapes.Ticks, {}, {
            color: 'CadetBlue'
        });
        track.add(timeAxis);

        timeAxisMacro.setTimeContext(timelineMacro.timeContext);
        timeAxisMacro.configureShape(wavesUI.shapes.Ticks,{},{
            color: 'CadetBlue"'
        });
        trackMacro.add(timeAxisMacro);


        // waveform layer
        var waveformLayer = new wavesUI.helpers.WaveformLayer(buffer, {
            height: layerHeight,
            top: timeAxisHeight,
            color: 'CadetBlue'
        });
        waveformLayer.setTimeContext(new wavesUI.core.LayerTimeContext(timeline.timeContext));
        track.add(waveformLayer);


        // Segment layer
        segmentLayer = new wavesUI.helpers.SegmentLayer(data, {
            height: layerHeight,
            top: timeAxisHeight,
            displayHandlers: true,
        });
        timeline.addLayer(segmentLayer, 'main');


        // Marker layer
        markerLayer = new wavesUI.core.Layer('collection', beatMarkers, {
            height: layerHeight,
            top: timeAxisHeight
        });
        markerLayer.setTimeContext(timeContext);
        markerLayer.configureShape(wavesUI.shapes.AnnotatedMarker, {
            x: function(d, v) {
                if (v !== undefined) {
                    d.time = v;
                }
                return d.time;
            },
            color: function() { return 'red'; }
        });
        markerLayer.setBehavior(new wavesUI.behaviors.MarkerBehavior());
        track.add(markerLayer);



        // cursorLayer
        cursorLayer = new wavesUI.helpers.CursorLayer({
            height: layerHeight + timeAxisHeight,
            color: 'white'
        });
        timeline.addLayer(cursorLayer, 'main');

        cursorLayerMacro = new wavesUI.helpers.CursorLayer({
            height: layerHeight,
            color: 'white'
        });
        timelineMacro.addLayer(cursorLayerMacro, 'macro');


        timeline.state = new wavesUI.states.SimpleEditionState(timeline);
        timelineMacro.state = new wavesUI.states.SimpleEditionState(timelineMacro);

        track.render();
        track.update();
        trackMacro.render();
        trackMacro.update();

        finalDur = timeline.timeContext.visibleDuration;

        timeline.timeContext.zoom = finalDur / windowWidth;

        timeline.tracks.render();
        timeline.tracks.update();
        timelineMacro.tracks.render();
        timelineMacro.tracks.update();

        document.getElementById('loading').innerHTML = '';

        // listen for time passing...
        (function loop() {
            if (playSong) {
                var d = new Date();
                currentTime = (d.getTime() / 1000) - startTime;
                updatePlugin(false);
                setTimeout(requestAnimationFrame(loop), 20);
            } else {
                cleanQueue()
                setTimeout(function() {
                    requestAnimationFrame(loop);
                    timeline.tracks.update();
                }, 200);
            }
        }());

        timeline.on('event', function(e) {
            var eventType = e.type;
            var segment = segmentLayer.getItemFromDOMElement(e.target);
            var onTimeAxis = $.inArray(timeAxis, timeline.getHitLayers(e));

            if (segment !== null && (eventType == 'mouseover' || eventType == 'mouseout')) {
                var datum = segmentLayer.getDatumFromItem(segment);
                datum.opacity = eventType == 'mouseout' ? 0.2 : 0.5;
                segmentLayer.updateShapes();
            } else if (!onTimeAxis && eventType == 'mousemove') {
                seeking = true;
                var newTime = timeAxis.timeToPixel.invert(e.x) - timeline.timeContext.offset;
                cursorLayer.currentPosition = newTime;
                cursorLayer.update();
            } else if (!onTimeAxis && eventType == 'mouseup') {
                var newTime = timeAxis.timeToPixel.invert(e.x) - timeline.timeContext.offset;
                player.seekTo(newTime)
                seekTo(newTime);
                seeking = false;
            }
        });

        timelineMacro.on('event', function(e) {
            var onTimeAxis = $.inArray(timeAxisMacro, timeline.getHitLayers);
            var eType = e.type;

            if (onTimeAxis && eType == 'mousemove') {
                seeking = true;
                var newTime = timeAxisMacro.timeToPixel.invert(e.x) - timelineMacro.timeContext.offset;
                cursorLayerMacro.currentPosition = newTime;
                cursorLayerMacro.update();
            } else if (onTimeAxis && eType == 'mouseup') {
                var newTime = timeAxisMacro.timeToPixel.invert(e.x) - timelineMacro.timeContext.offset;
                player.seekTo(newTime);
                seekTo(newTime);
                seeking = false;
            };
        });

    }

    // Renders all layers from the WavesJS plugin and plays a sound when
    // encountering a beat marker
    function updatePlugin(seeked) {
        if (!seeking) {
          cursorLayer.currentPosition = currentTime;
          cursorLayer.update();
          cursorLayerMacro.currentPosition = currentTime;
          cursorLayerMacro.update();
        }
        timeline.timeContext.offset = -currentTime + (finalDur / windowWidth) / 2;
        timeline.tracks.update();

        if(currentTime >= markerQueue[0] && !seeked) {
            console.log("removed beat from Queue");
            playClick();
            markerQueue.shift();
        }
    }

    function seekTo(newTime) {
        currentTime = newTime;
        var d = new Date();
        startTime = d.getTime()/1000 - currentTime;
        cleanQueue();
        audioplayer.currentTime = currentTime;
        updatePlugin(true);
    };

    function writeToPage() {
        document.getElementById('markerInfo').hidden = ""
        var objString = "[ ";
        for (i = 0; i < beatMarkers.length; i++) {
            var temp = beatMarkers[i];
            SingleObjString = "{ " + temp.time.toString() + ", " + temp.text.toString() + " },";
            objString = objString + SingleObjString;
        }
        objString = objString.replace(/,$/, "") + " ]";

        document.getElementById('markerInfo').value = objString;
    }

    function writeToFile() {
        var toSend = [];
        for (i = 0; i < beatMarkers.length; i++) {
            toSend.push(beatMarkers[i].time);
        }
        console.log(toSend);
        var xhttp;
        var url = "writefile.php";
        var params = "beat=" + toSend.toString();
        var ytID = "ytID=" + getYoutubeId();
        if (window.XMLHttpRequest) {
            // code for modern browsers
            xhttp = new XMLHttpRequest();
        } else {
            // code for IE6, IE5
            xhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xhttp.open("POST", "writefile.php", true);
        //Send the proper header information along with the request
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.onreadystatechange = function() {
        if (xhttp.readyState == 4 && xhttp.status == 200) {
            document.getElementById("demo").innerHTML = xhttp.responseText;
            }
        };
        xhttp.send(params + "&" + ytID);
        window.alert("Thank you! Your beat annotations are saved to the server.");
    }


    function clearMarkers() {
        beatMarkers.length = 0;
        markerLayer.render();
        markerLayer.update();
        markerCounter = 1;
    }

    window.addEventListener("keydown", checkKeyPressed, false);
    window.addEventListener("mouseup", mouseUpOutOfBounds, false);

    function mouseUpOutOfBounds() {
        seeking = false;
    }

    var clickSound = new Audio('click.ogg');
    var clickSound2 = new Audio('click.ogg');

    var metronome = 1;

    function toggleClick() {
        if (metronome > 0) {
            metronome = 0;
            document.getElementById('clickToggle').innerHTML = '<span class="	glyphicon glyphicon-volume-off"></span> Click OFF'
        } else {
            metronome = 1;
            document.getElementById('clickToggle').innerHTML = '<span class="	glyphicon glyphicon-volume-up"></span> Click ON'
        }
    }

    function playClick() {
        if (metronome == 1) {
            clickSound.play();
            metronome = 2;
        } else if (metronome == 2) {
            clickSound2.play();
            metronome = 1;
        }
    }

    // Gets the Youtube video-ID from the URL
    function getYoutubeId() {
        var query = window.location.search.substring(1);
        var id = query.split("=");
        return id[1];
    }

    // Implementation of the Youtube API, retrieved and modified from: https://developers.google.com/youtube/iframe_api_reference
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";

    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // This function creates an <iframe> (and YouTube player)
    // after the API code downloads.
    var player;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '240',
            width: '240',
            videoId: getYoutubeId(),
            playerVars: {
                'controls': 0,
                'autoplay': 0,
                'fs': 0,
                'disablekb': 0
            },
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
    };

    // When the yt player's state changes, synchronizes the wavesurfer player
    var done = false;

    // Pauses the YT video when it's playing and starts playback when it's paused.
    function playOrPause() {
        if (player.getPlayerState() == 1) {
            player.pauseVideo();
            document.getElementById('playButton').innerHTML = '<i class="glyphicon glyphicon-play"></i> Play'
        } else {
            cleanQueue();
            player.playVideo();
            document.getElementById('playButton').innerHTML = '<i class="glyphicon glyphicon-pause"></i> Pause';
        }
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
            player.mute();
            var d = new Date();
            startTime = d.getTime() / 1000;
            currentTime = player.getCurrentTime();
            audioplayer.currentTime = currentTime;
            cleanQueue();
            playSong = true;
            done = true;
        } else if (event.data != YT.PlayerState.PLAYING) {
            cleanQueue();
            audioplayer.pause();
            playSong = false;
        } else if (event.data == YT.PlayerState.PLAYING) {
            cleanQueue();
            audioplayer.play();
            seekTo(currentTime);
            playSong = true;
        }
    }

    function checkKeyPressed(e) {
        var evtobj = window.event ? event : e
        if (e.keyCode == "32") {
            e.preventDefault();
            playOrPause();
            player.seekTo(currentTime, true);
            audioplayer.currentTime = currentTime;
            return false;
        } else if (e.keyCode == "66") {
            playClick();
            recordTimeStamp();
        } else if (e.keyCode == "46") {
            var selectedMarker = document.getElementsByClassName('item annotated-marker selected');
            console.log(selectedMarker[0].childNodes[2].innerHTML);
            var i;
            for (i = 0; i < beatMarkers.length; i++) {
                if (beatMarkers[i].text == selectedMarker[0].childNodes[2].innerHTML) {
                    // put the element to be deleted at the end, and pop it off
                    var temp = beatMarkers[i];
                    beatMarkers[i] = beatMarkers[beatMarkers.length - 1];
                    beatMarkers[beatMarkers.length - 1] = temp;
                    beatMarkers.pop();
                    break;
                }
            }
            markerLayer.render();
            markerLayer.update();
        }
    }

    function cleanQueue() {
        markerQueue = [];
        for (var i = 0; i < beatMarkers.length; i++) {
            if(beatMarkers[i].time > currentTime){
                markerQueue.push(beatMarkers[i].time);
            }
        }
        markerQueue.sort(function(a,b) {
            return a-b;
        });
    }

    function recordTimeStamp() {
        var newmarker = {
            time: currentTime,
            text: markerCounter.toString()
        }
        markerCounter++;
        beatMarkers.push(newmarker);
        markerLayer.render();
        markerLayer.update();
    }
    </script>
</body>

</html>
